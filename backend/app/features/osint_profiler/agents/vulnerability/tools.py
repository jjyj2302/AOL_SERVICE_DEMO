"""
VulnerabilityAgent Tools - 취약점 분석 도구 모음

책임:
- CVE 분석 도구 생성 (NIST NVD)
- 종합 IOC 분석 도구 생성 (Pulsedive)

변경사항:
- API 키를 캐시에서 조회 (DB 의존성 제거)
- Agent 인스턴스 파라미터 제거
"""

from typing import List
from langchain_core.tools import Tool, StructuredTool
from pydantic import BaseModel, Field

from app.features.ioc_tools.ioc_lookup.single_lookup.service import external_api_clients
from app.core.settings.api_keys.cache import get_apikey_cached

# Pydantic Input Schemas (입력 검증)
class CVEInput(BaseModel):
    """CVE 식별자 입력 검증 스키마"""
    cve_id: str = Field(
          description=" 조사할 CVE 식별자. 예: 'CVE-2021-44228' (Log4Shell)"
    )

class IOCInput(BaseModel):
    """범용 IOC 입력 스키마 (IP, domain, hash, URL 등)"""
    ioc: str = Field(
        description="조사할 IOC (IP, domain, hash, URL 등). 예: '8.8.8.8'"
    )

# CVE Analysis Tools
def create_cve_tools() -> List[Tool]:
    """
    CVE 분석 도구 1개 생성

    Tools:
        NIST NVD - 공식 CVE 데이터베이스 (CVSS 점수, CWE, 영향 받는 제품)

    Returns:
        List[Tool]: LangChain StructuredTool 리스트
    """
    tools = []

    # NIST NVD CVE Lookup (캐시에서 API 키 조회)
    nvd_key = get_apikey_cached("nistnvd")
    if nvd_key.get('key'):  # API 키가 존재하면 도구 생성
        def nvd_cve_lookup(cve_id: str) -> dict:
            """
            NIST NVD CVE 정보 조회
            Args:
                cve_id: CVE 식별자 (예: CVE-2021-44228)
            Returns:
                dict: NVD API 응답 (CVSS 점수, CWE, 영향 받는 제품, 패치 정보)
              """
            return external_api_clients.search_nist_nvd(
                ioc=cve_id,
                apikey=nvd_key['key']  # dict에서 실제 API 키 문자열 추출
            )

        tools.append(StructuredTool.from_function(
            func=nvd_cve_lookup,
            name="nist_nvd_cve_lookup",
            description="""Official NIST NVD CVE database lookup for vulnerability intelligence.
            USE WHEN:
            - Investigating known CVEs in incident response or threat hunting
            - Assessing vulnerability severity (CVSS v3 base score 0-10)
            - Identifying affected products/versions and available patches
            - Mapping vulnerabilities to CWE categories for root cause analysis
            RETURNS:
            JSON with cve.id, 
            cve.descriptions (English summary), 
            cve.metrics.cvssMetricV3 (baseScore/baseSeverity/vectorString), 
            cve.weaknesses (CWE IDs), 
            cve.configurations (affected CPE products), 
            cve.references (patches/advisories), 
            cve.published/lastModified timestamps.
            LIMITS:
            - Free tier: 5 req/30sec without key, 50 req/30sec with API key
            - Returns 403 on rate limit; use 6-second delay between requests
            - Historic CVE data may have incomplete CVSS v3 (check cvssMetricV2 fallback)
            DON'T USE:
            - For 0-day vulnerabilities not yet assigned CVE (won't return results)
            - As real-time exploit availability check (NVD doesn't track active exploitation)
            - For non-CVE identifiers (won't accept vendor advisory IDs)
            WORKFLOW:
            After IOC analysis → identify software versions → CVE lookup → check CVSS ≥7.0 → validate patch status → prioritize remediation by exploitability + business impact.""",
            args_schema=CVEInput  # Pydantic 스키마로 입력 검증
        ))

    return tools


# Multi-Source IOC Analysis Tools

def create_multisource_tools() -> List[Tool]:
    """
    종합 IOC 분석 도구 1개 생성

    Tools:
        Pulsedive - 다중 소스 IOC 평판 집계 (IP/domain/hash 통합 검색)

    Returns:
        List[Tool]: LangChain StructuredTool 리스트
    """
    tools = []

    # Pulsedive Multi-Source IOC Lookup (캐시에서 API 키 조회)
    pulsedive_key = get_apikey_cached("pulsedive")
    if pulsedive_key.get('key'):  # API 키가 존재하면 도구 생성
        def pulsedive_ioc_lookup(ioc: str) -> dict:
            """
            Pulsedive 종합 IOC 평판 조회

            Args:
                ioc: 조사할 IOC (IP, domain, hash, URL 등)

            Returns:
                dict: Pulsedive API 응답 (위협 점수, 태그, 연관 IOC, 피드 소스)
            """
            return external_api_clients.check_pulsedive(
                ioc=ioc,
                apikey=pulsedive_key['key']  # dict에서 실제 API 키 문자열 추출
            )

        tools.append(StructuredTool.from_function(
            func=pulsedive_ioc_lookup,
            name="pulsedive_ioc_intelligence",
            description="""Multi-source threat intelligence aggregator for IOC reputation (IP/domain/hash/URL).
            USE WHEN:
            - Quick unified verdict across multiple threat feeds (no need to call 5 separate APIs)
            - Discovering IOC relationships and infrastructure pivoting (linked domains/IPs)
            - Enriching alerts with threat tags (malware family, campaign, TTP)
            - Validating low-confidence IOCs with community consensus
            RETURNS:
            JSON with risk (none/low/medium/high/critical), 
            threat (threat type labels), 
            properties (geolocation/ASN/ports/protocols),
            feeds (array of contributing threat intel sources), 
            attributes (tags like phishing/ransomware), threats (related indicators),
            stamp_seen/stamp_updated (first/last seen timestamps).
            LIMITS:
            - Free tier: 30 req/min, 300 req/day; returns 429 on rate limit
            - May return "unknown" risk for novel/uncategorized IOCs (not malicious = low feed coverage)
            DON'T USE:
            - As definitive ground truth (aggregator lag + feed quality varies)
            - For internal/RFC1918 IPs (won't have public threat intel)
            - For real-time blocking decisions without corroboration (use multi-source validation)
            WORKFLOW:
            Use as first-pass triage → check risk level → if medium/high, 
            drill down with specialized tools (VirusTotal for malware, Shodan for infrastructure) 
            → extract related IOCs from threats field → expand investigation radius.""",
            args_schema=IOCInput  # Pydantic 스키마로 입력 검증
        ))

    return tools
