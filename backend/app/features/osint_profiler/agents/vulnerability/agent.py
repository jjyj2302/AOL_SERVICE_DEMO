"""
CVE 취약점 분석 전문 에이전트
"""

from langchain_openai import ChatOpenAI
from langgraph.prebuilt import create_react_agent

from .tools import create_cve_tools
from app.core.settings.api_keys.cache import APIKeyCache
from app.features.osint_profiler.state import OsintState


def create_vulnerability_agent(llm_model: str = "gpt-4"):
    """
    CVE/취약점 분석 ReAct 에이전트 생성 (NVD만 사용)

    Args:
        llm_model: 사용할 LLM 모델

    Returns:
        CompiledGraph
    """
    # DB에서 OpenAI API 키 가져오기
    api_cache = APIKeyCache.get_instance()
    openai_key = api_cache.get_key("openai").get("key", "")

    llm = ChatOpenAI(model=llm_model, temperature=0, api_key=openai_key)
    
    # NVD 도구만 사용
    tools = create_cve_tools()

    # create_react_agent 사용
    return create_react_agent(
        model=llm,
        tools=tools,
        name="vulnerability_expert",
        state_schema=OsintState,
        prompt="""You are a CVE vulnerability analysis expert.
        Use NVD (National Vulnerability Database) to analyze CVE identifiers.
        Provide CVSS scores, severity levels, and vulnerability details."""
    )
