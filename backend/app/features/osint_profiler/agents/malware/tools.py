"""
MalwareAgent Tools - 악성 코드 분석 도구 모음
Hash 분석 도구 3개 + URL 분석 도구 1개
- API 키 로딩 (get_apikey 사용)
- Hash 분석 도구 생성 (VirusTotal, MalwareBazaar, ThreatFox)
- URL 분석 도구 생성 (URLhaus)
- LangChain Tool 래핑 및 입력 검증
"""

from typing import List
from langchain.tools import Tool, StructuredTool
from pydantic import BaseModel, Field 

# 기존 API 클라이언트 호출 (external_api_clients.py)
from app.features.ioc_tools.ioc_lookup.single_lookup.service import external_api_clients
# API 키 조회 유틸리티
from app.core.settings.api_keys.crud.api_keys_settings_crud import get_apikey

# Pydantic Input Schemas (입력 검증)
class HashInput(BaseModel):
    """
    해시 입력 검증 스키마
    MD5 (32자), SHA1 (40자), SHA256 (64자) 형식 지원
    """
    hash_value: str = Field(
        description="파일 해시 (MD5, SHA1, SHA256). 예: '44d88612fea8a8f36de82e1278abb02f' (MD5)"
    )

class URLInput(BaseModel):
    """
    URL 입력 검증 스키마
    전체 URL 형식 필요 (프로토콜 포함)
    """
    url: str = Field(
        description="분석할 전체 URL. 예: 'http://malicious.example.com/path'"
    )

# Hash Analysis Tools (3개)
def create_hash_tools(agent_instance) -> List[Tool]:
    """
    해시 분석 도구 생성
    Tools:
    1. VirusTotal - 70+ AV 엔진 멀티 스캔, 관계 그래프, 행위 분석
    2. MalwareBazaar - abuse.ch 커뮤니티 멀웨어 샘플 DB (무료)
    3. ThreatFox - abuse.ch IOC 위협 인텔리전스 (캠페인 매핑)

    Args:
        agent_instance: MalwareAgent 인스턴스
                        agent_instance.db로 SQLAlchemy 세션 접근
    Returns:
        List[Tool]: LangChain StructuredTool 리스트
    """
    tools = []
    db = agent_instance.db # BaseOSINTAgent에서 상속받은 DB 세션
    # 1. VirusTotal Hash Lookup
    vt_key = get_apikey(db, "virustotal")
    if vt_key:
        def virustotal_hash_check(hash_value: str) -> dict:
            """
            VirusTotal 파일 해시 분석

            Args:
                hash_value: MD5/SHA1/SHA256 해시
            Returns:
                dict: VirusTotal API 응답 값 (detection ratio, file metadata, relations 등)
            """
            return external_api_clients.virustotal(
                ioc=hash_value,
                type='hash',
                apikey=vt_key
            )
        tools.append(StructuredTool.from_function(
            func=virustotal_hash_check,
            name="virustotal_hash_lookup",
            description="""Multi-AV(70+) hash reputation & behavior analysis.
            USE WHEN:
            - Quick malicious verdict needed.
            - Engine-wise detections/community comments/realtions (IP·domain) required
            - IR metadata(first/last_seen) fast retrieval
            RETURNS:
            - last_analysis_stats(detection ratio), file meta(name/size.type), behavior(network·file·registry), relation graph, comments/reputation
            LIMITS:
            - Public: ~4 req/min, ~500 req/day (subject to change)
            - Hash-only lookup recommended (no upload for policy compliance)
            DON'T USE:
            - Novel/unregisted hash(may return empty)
            - Already confirmed malicious by internal/MBZ(save quota)
            WORKFLOW: MalwareBazaar(free screening) -> VirusTotal(accurate verdict) -> extract relations(IP/domain) -> expand IOCS"""
            , args_schema=HashInput
        ))
    
    # 2. MalwareBazaar Hash Lookup
    mbz_key = get_apikey(db, "malwarebazaar")
    if mbz_key:
        def malwarebazaar_hash_check(hash_value: str) -> dict:
            """
            MalwareBazaar 멀웨어 샘플 DB 검색
            Args:
                hash_value: MD5/SHA1/SHA256 해시
            Returns:
                dict: MalwareBazaar API 응답 값 (family, tags, YARA signature)"""
            return external_api_clients.malwarebazaar_hash_check(
                ioc=hash_value,
                apikey=mbz_key
            )
            
        tools.append(StructuredTool.from_function(
            func=malwarebazaar_hash_check,
            name="malwarebazaar_hash_lookup",
            description="""abuse.ch community malware sample DB lookup(free/no key).
            USE WHEN:
            - 1st-pass 'known sample' screening(save VT quota)
            - Family/tags/signature(YARA)·first/last_seen needed
            RETURNS:
            - family/alias, tags, file_type/name/size, first_seen/last_seen, signature(YARA), (research) download link
            LIMITS:
            - Free, minimal rate limit(service quality consideration)
            DON'T USE:
            - Benign files(mostly unregistered)
            - Zero-day/very recent samples(update lag possible)
            WORKFLOW: Use as first-pass filter → if matched, get family/tags → proceed to VT for detailed analysis""",
            args_schema=HashInput
        ))

    # 3. ThreatFox Hash Lookup
    tf_key = get_apikey(db, "threatfox")
    if tf_key:
        def threatfox_hash_check(hash_value: str) -> dict:
            """ThreatFox IOC 위협 인텔리전스 검색"""
            return external_api_clients.threatfox_ip_check(
                ioc=hash_value,
                apikey=tf_key
            )
        
        tools.append(StructuredTool.from_function(
              func=threatfox_hash_check,
              name="threatfox_hash_lookup",
              description="""abuse.ch ThreatFox IOC DB hash-based threat intel lookup.
              USE WHEN:
              - Hash ↔ campaign/family mapping, C2/payload type identification
              - Latest intel(confidence/first_seen/tags) for rule enrichment
              RETURNS:
              - malware_alias/printable, threat_type(payload/c2 etc), confidence_level, first_seen, tags, reference links
              LIMITS:
              - Free, minor rate limit exists(public figures vary)
              DON'T USE:
              - Old sample long-term history(focus on recent threats)
              - Simple sample meta only(→ MBZ first)
              WORKFLOW: Use after MBZ/VT for campaign context → extract C2 servers/domains → expand IOCs for infrastructure mapping""",
              args_schema=HashInput
          ))
    
    return tools

# URL Analysis Tools
def create_url_tools(agent_instance) -> List[Tool]:
    """
    URL 분석 도구 생성
    Tools:
    1. URLhaus - abuse.ch 악성 URL 데이터베이스

    Args:
        agent_instance: MalwareAgent 인스턴스
                        agent_instance.db로 SQLAlchemy 세션 접근
    Returns:
        List[Tool]: LangChain StructuredTool 리스트
    """
    tools = []
    db = agent_instance.db # BaseOSINTAgent에서 상속받은 DB 세션
    
    # URLhaus URL Lookup
    uh_key = get_apikey(db, "urlhaus")
    if uh_key:
        def urlhaus_url_check(url: str) -> dict:
            """
            URLhaus 악성 URL DB 검색
            Args:
                url: 전체 URL (프로토콜 포함)
            Returns:
                dict: URLhaus API 응답 값 (malware family, distribution method 등)
            """
            return external_api_clients.urlhaus_url_check(
                ioc=url,
                apikey=uh_key
            )
        
        tools.append(StructuredTool.from_function(
            func=urlhaus_url_check,
            name="urlhaus_url_lookup",
            description="""abuse.ch URLhaus community malicious/phishing URL DB lookup(free/no key).
            USE WHEN:
            - Quick check for known malicious URLs(save VT quota)
            - Malware family/distribution method needed
            RETURNS:
            - malware_family, distribution_method, first_seen, tags, reference links
            LIMITS:
            - Free, minimal rate limit(service quality consideration)
            DON'T USE:
            - Benign URLs(mostly unregistered)
            - Zero-day/very recent URLs(update lag possible)
            WORKFLOW: Use as first-pass filter → if matched, get family/method → proceed to VT for detailed analysis""",
            args_schema=URLInput
        ))
    
    return tools